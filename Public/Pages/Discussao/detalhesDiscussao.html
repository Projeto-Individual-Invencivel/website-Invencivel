<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussão</title>
    <link rel="stylesheet" href="detalhesDiscussao.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="../../Assets/Icons/favicon.ico" type="image/x-icon">
    <script src="../../Js/sessionStorage.js"></script>
</head>
<body>
    <div class="navBar">
        <div class="box-img">
            <a href="../../index.html">
                <img src="../../Assets/Images/logo-website.png" width="135em" height="70em" alt="imagem com o texto 'invencivel'" onclick="limpar()">
            </a>
        </div>
        <div class="box-links">
            <ul>
                <li><a href="../Forum/forum.html">Fórum</a></li>
                <li>|</li>
                <li id="link1NavBar"><a href="../Login/login.html">Login</a></li>
                <li>|</li>
                <li id="link2NavBar"><a href="../Cadastro/cadastro.html">Cadastro</a></li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="container-post" id="div_postagem">
            <!-- Estrutura da postagem do topico 
                <div class="box-likes">
                <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                <span>123</span>
                <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
            </div>
            <div class="box-topico">
                <div class="box-dados-post">
                    <span>nome_autor</span>
                    <span>Postagem: 03/05/2024</span>
                </div>
                <div class="box-titulo-post">
                    <h1>Cenas épicas em Invencível
                    </h1>
                </div>
                <div class="box-conteudo-post">
                    <span>
                        Quais foram as cenas mais épicas que você viu em Invencível até agora? Discuta momentos de ação e emocionantes.
                        As cenas épicas em Invencível são de tirar o fôlego!
                    </span>
                </div>
            </div> -->
        </div>
        <div class="container-resposta" id="div_responderTopico">
            <textarea id="txt_resposta" placeholder="Escreva sua resposta aqui"></textarea>
            <div>
                <button class="btn-responder" id="btn_resposta">Responder</button>
                <button class="btn-cancelar" id="btn_cancelar">Cancelar</button>
            </div>
        </div>
        <div class="container-comentario" id="div_comentarios">
            <!-- Estrutura que contem os comentarios da sessão -->
            <!-- <div class="estrutura-comentario">
                <div class="box-comentario">
                    <div class="box-likes-comentario">
                        <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                        <span>123</span>
                        <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
                    </div>
                    <div class="box-dados-comentario">
                        <div class="box-autor-comentario">
                            <span>nome_autor</span>
                            <span>Postagem: 03/05/2024</span>
                        </div>
                        <div class="box-comentario-usuario">
                            <span></span>
                        </div>
                        <div class="box-responder-comentario">
                            <textarea id="" placeholder="Escreva sua resposta aqui"></textarea>
                            <button class="btn-responder-comentario">Responder</button>
                        </div>
                    </div>
                </div>
                <div class="box-resposta-comentario-topico">
                    <div class="estrutura-comentario">
                        <div class="box-comentario">
                            <div class="box-likes-comentario">
                                <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                                <span>123</span>
                                <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
                            </div>
                            <div class="box-dados-comentario">
                                <div class="box-autor-comentario">
                                    <span>nome_autor</span>
                                    <span>Postagem: 03/05/2024</span>
                                </div>
                                <div class="box-comentario-usuario">
                                    <span></span>
                                </div>
                                <div class="box-responder-comentario">
                                    <textarea id="" placeholder="Escreva sua resposta aqui"></textarea>
                                    <button class="btn-responder-comentario">Responder</button>
                                </div>
                            </div>
                        </div>
                        <div class="box-resposta-comentario">
                            
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
    </div>
    <div class="footer">
        <span>©BrunoGomes 2024 Todos os direitos reservados.</span>
    </div>
</body>
</html>
<script>
    window.onload = () => {

        if(sessionStorage.ID_USUARIO != undefined){
            link1NavBar.innerHTML = `
                <a href="../Quizzes/quizzes.html">Quiz</a>
            `;
            link2NavBar.innerHTML = `
                <a href="../../index.html" onclick="limpar()">Sair</a>
            `;
            div_responderTopico.style.display = "flex";
        }

        let url = `/forum/discussao/${sessionStorage.ID_AUTOR}/${sessionStorage.ID_DISCUSSAO}`;
        fetch(url, {
            method: 'GET',
            headers: {
                "Content-Type": 'application/json'
            }
        }).then(res => {

            if(res.ok){
                res.json().then((data) => {
                    
                    let newData = new Date(data.dtPostagem);
                    let formData = `${newData.getDate()}/${newData.getMonth() + 1}/${newData.getFullYear()}` 

                    div_postagem.innerHTML = `
                        <div class="box-likes">
                            <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                            <span>${data.curtidas}</span>
                            <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
                        </div>
                        <div class="box-topico">
                            <div class="box-dados-post">
                                <span>${data.autor}</span>
                                <span>Postagem: ${formData}</span>
                            </div>
                            <div class="box-titulo-post">
                                <h1>${data.titulo}</h1>
                            </div>
                            <div class="box-conteudo-post">
                                <span>
                                    ${data.descricao}
                                </span>
                            </div>
                        </div>
                    `;
                    organizarComentarios(data.comentarios)
                })
            } else{
                res.text().then((data) => {
                    console.error(data);
                })
            }
        })
    }

    btn_resposta.onclick = () => {
        btn_resposta.innerHTML = "Publicar";
        btn_cancelar.style.display = 'flex';
        txt_resposta.style.display = "flex";
    } 
    btn_cancelar.onclick = () => {
        btn_resposta.innerHTML = "Responder";
        txt_resposta.style.display = "none";
        btn_cancelar.style.display = 'none';
    }

    function organizarComentarios(comentarios){

        const comentariosPrincipais = [];
        for(let i = 0; i < comentarios.length; i++){
            if(comentarios[i].fkRespostaComentario == null){
                
                let box = comentarios.filter(x => x.fkRespostaComentario == comentarios[i].id_comentario);
                comentarios[i].respostas = box;

                comentariosPrincipais.push(comentarios[i]);
            }
        }

        for(let i = 0; i < comentariosPrincipais.length; i++){

            let newData = new Date(comentariosPrincipais[i].dtPostagem);
            let formData = `${newData.getDate()}/${newData.getMonth() + 1}/${newData.getFullYear()}` 

            const dadosComentario = comentariosPrincipais[i];
            div_comentarios.innerHTML += `
                <div class="estrutura-comentario">
                    <div class="box-comentario">
                        <div class="box-likes-comentario">
                            <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                            <span>${dadosComentario.curtidas}</span>
                            <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
                        </div>
                        <div class="box-dados-comentario">
                            <div class="box-autor-comentario">
                                <span>${dadosComentario.autor}</span>
                                <span>Postagem: ${formData}</span>
                            </div>
                            <div class="box-comentario-usuario">
                                <span>${dadosComentario.comentario}</span>
                            </div>
                            <div class="box-responder-comentario">
                                <textarea id="" placeholder="Escreva sua resposta aqui"></textarea>
                                <button class="btn-responder-comentario">Responder</button>
                            </div>
                        </div>
                    </div>
                    <div class="box-resposta-comentario-topico" id="respostaComentario${i}">
                    </div>
                </div>
            `;
            for(let index = 0; index < dadosComentario.respostas.length; index++){

                const dadosResposta = dadosComentario.respostas[index];

                let newData = new Date(dadosResposta.dtPostagem);
                let formData = `${newData.getDate()}/${newData.getMonth() + 1}/${newData.getFullYear()}`;

                document.getElementById(`respostaComentario${i}`).innerHTML += `
                    <div class="estrutura-comentario">
                        <div class="box-comentario">
                            <div class="box-likes-comentario">
                                <button><img src="../../Assets/Images/arrow-top.png" height="20em" alt="seta para cima"></button>
                                <span>${dadosResposta.curtidas}</span>
                                <button><img src="../../Assets/Images/arrow-bottom.png" height="20em" alt="seta para baixo"></button>
                            </div>
                            <div class="box-dados-comentario">
                                <div class="box-autor-comentario">
                                    <span>${dadosResposta.autor}</span>
                                    <span>Postagem: ${formData}</span>
                                </div>
                                <div class="box-comentario-usuario">
                                    <span>${dadosResposta.comentario}</span>
                                </div>
                                <div class="box-responder-comentario">
                                    <textarea id="" placeholder="Escreva sua resposta aqui"></textarea>
                                    <button class="btn-responder-comentario">Responder</button>
                                </div>
                            </div>
                        </div>
                        <div class="box-resposta-comentario">
                            
                        </div>
                    </div>
                `;
            }
        }
    }
</script>