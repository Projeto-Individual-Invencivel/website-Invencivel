<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="perfil.css">
    <script src="../../Js/sessionStorage.js"></script>
    <link rel="shortcut icon" href="../../Assets/Icons/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="navBar">
        <div class="box-img">
            <a href="../../index.html">
                <img src="../../Assets/Images/logo-website.png" width="135em" height="70em" alt="imagem com o texto 'invencivel'" onclick="limpar()">
            </a>
        </div>
        <div class="box-links">
            <ul id="ul_linksNav">
                <li><a href="#" style="text-decoration: underline;">Perfil</a></li>
                <li>|</li>
                <li><a href="../Forum/forum.html" onclick="sessionStorage.removeItem('ID_VISITANTE')">Fórum</a></li>
                <li>|</li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="box-usuario">
            <div class="info-usuario" id="div_informacoesUsuario">
                <!-- caixa com as informacoes do usuário -->
            </div>
            <div class="info-publicacoes">
                <div class="box-extras">
                    <div class="square" id="div_numCurtidas"></div>
                    <strong>Curtidas recebidas</strong>
                </div>
                <div class="box-extras">
                    <div class="square" id="div_numPostagens"></div>
                    <strong>Postagens publicadas</strong>
                </div>
                <div class="box-extras">
                    <div class="square" id="div_numComentarios"></div>
                    <strong>Comentários publicados</strong>
                </div>
            </div>
        </div>
        <div class="box-interacoes">
            <div class="box-titulo-pub" id="btn_postagens">
                <strong>Postagens:</strong>
            </div>
            <div class="box-conteudos" id="div_postagens">
                <div class="conteudos" id="div_conteudoPosts">
                    <!-- postagens do usuario -->
                </div>
            </div>
            <div class="box-titulo-com" id="btn_comentarios">
                <strong>Comentários:</strong>
            </div>
            <div class="box-conteudos" id="div_comentarios">
                <div class="conteudos" id="div_conteudoComments">
                    <!-- comentarios do usuario -->
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <span>©BrunoGomes 2024 Todos os direitos reservados.</span>
    </div>
</body>
</html>
<script>
    window.onload = () => {

        infoUsuario();
        ajustarNavBar();
        interacoesUsuario();
    }

    const infoUsuario = () => {

        let idPerfil = 0;
        if(sessionStorage.ID_VISITANTE == sessionStorage.ID_USUARIO || sessionStorage.ID_VISITANTE == undefined){
            idPerfil = sessionStorage.ID_USUARIO;
        } else{
            idPerfil = sessionStorage.ID_VISITANTE;
        }

        fetch(`/usuarios/perfil/${idPerfil}`, {
            method: 'GET',
            mode: 'cors'
        }).then((res) => {
            if(res.ok){
                res.json().then((data) => {
                    
                    div_numCurtidas.innerHTML = `${data.likesPosts + data.likesComments}`;
                    div_numPostagens.innerHTML = data.posts;
                    div_numComentarios.innerHTML = data.coments;

                    if(sessionStorage.ID_USUARIO == sessionStorage.ID_VISITANTE || sessionStorage.ID_VISITANTE == undefined){

                        let dtFormatada = new Date(data.dtNasc);
                        let mes = dtFormatada.getMonth() + 1;
                        mes = mes < 10 ? '0' + mes : mes;

                        div_informacoesUsuario.innerHTML = `
                            <h2>Suas Informações:</h2>
                            <input type="text" placeholder="Nome de usuário" value="${data.nome}">
                            <input type="text" placeholder="Email do usuário" value="${data.email}">
                            <input type="date" value="${dtFormatada.getFullYear()}-${mes}-${dtFormatada.getDate()}">
                            <span class="span-inscricao">${dataInscricao(new Date(data.dtContaCriada))}</span>
                            <div class="box-eventos">
                                <button class="btn-salvar">Salvar</button>
                                <button class="btn-descartar" onclick="infoUsuario()">Descartar</button>
                            </div>
                        `;
                    } else{
                        div_informacoesUsuario.innerHTML = `
                            <h1 style="font-size: 3em">${data.nome}</h1>
                            <span>${data.email}</span>
                            <span class="span-inscricao" style="width: 35%; margin-top: 2%;">${dataInscricao(new Date(data.dtContaCriada))}</span>
                        `;
                    }
                })
            } else{
                res.text().then((err) => {
                    console.log(err);
                })
            }
        })
    }

    const dataInscricao = (ContaCriada) => {

        const dt = new Date(ContaCriada);

        const meses = [ 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const msg = `Na plataforma desde ${meses[dt.getMonth()]} de ${dt.getFullYear()}`;
        return msg;
    }

    const ajustarNavBar = () => {

        if(sessionStorage.ID_USUARIO != undefined){
            ul_linksNav.innerHTML += `
                <li><a href="../Quizzes/quizzes.html" onclick="sessionStorage.removeItem('ID_VISITANTE')">Quiz</a></li>
                <li>|</li>
                <li><a href="../../index.html" onclick="sessionStorage.clear()">Sair</a></li>
            `;  
        } else{
            ul_linksNav.innerHTML += `
                <li><a href="../Login/login.html">Login</a></li>
                <li>|</li>
                <li><a href="../Cadastro/cadastro.html">Cadastro</a></li>
            `;
        }
    }

    const interacoesUsuario = () => {

        let idPerfil = 0;
        if(sessionStorage.ID_VISITANTE == sessionStorage.ID_USUARIO || sessionStorage.ID_VISITANTE == undefined){
            idPerfil = sessionStorage.ID_USUARIO;
        } else{
            idPerfil = sessionStorage.ID_VISITANTE;
        }

        fetch(`/usuarios/publicacoes/${idPerfil}`, {
            method: 'GET',
            mode: 'cors'
        }).then((res) => {
            if(res.ok){
                res.json().then((data) => {

                    data.postagens.map((item) => {

                        let dt = new Date(item.dtPostagem);
                        let mes = dt.getMonth() + 1;
                        mes = mes < 10 ? '0' + mes : mes;

                        let minuto = dt.getMinutes();
                        minuto = minuto < 10 ? '0' + minuto : minuto;

                        div_conteudoPosts.innerHTML += `
                            <div class="info-conteudo">
                                <h3>${item.titulo}</h3>
                                <div>
                                    <ul>
                                        <li>Curtidas: ${item.curtidas}</li>
                                        <li>|</li>
                                        <li>Postagem: ${dt.getDate()}/${mes}/${dt.getFullYear()} às ${dt.getHours()}:${minuto}</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    })
                    data.comentarios.map((item) => {
                        let dt = new Date(item.dtPostagem);
                        let mes = dt.getMonth() + 1;
                        mes = mes < 10 ? '0' + mes : mes;

                        let minuto = dt.getMinutes();
                        minuto = minuto < 10 ? '0' + minuto : minuto;

                        div_conteudoComments.innerHTML += `
                            <div class="info-conteudo">
                                <h3>${item.comentario}</h3>
                                <div>
                                    <ul>
                                        <li>Curtidas: ${item.curtidas}</li>
                                        <li>|</li>
                                        <li>Postagem: ${dt.getDate()}/${mes}/${dt.getFullYear()} às ${dt.getHours()}:${minuto}</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    })
                })
            } else{
                res.text().then((err) => {
                    console.error(err)
                })
            }
        })
    }
</script>